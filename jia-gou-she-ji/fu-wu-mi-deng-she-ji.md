# 服务密等设计

## 什么是密等

HTTP的幂等性指的是一次和多次请求某一个资源应该具有相同的结果。如通过PUT接口将数据的Status置为1，无论是第一次执行还是多次执行，获取到的结果应该是相同的，即执行完成之后Status =1。

简而言之：幂等性就是同样的参数，重复请求相同的服务，必须得到相同的结果。

## 密等的目的是什么

服务的密等性是保证服务高可用的重要一步，因为在微服务中因为网络波动、系统资源分配的不确定性、跨机房的请求等等原因，都会或多或少的导致一小部分请求的失败。而这部分失败的请求中，一般都会通过重试请求以达到服务的可用性，所以必须保证服务的密等性，尤其是设计转账或交易等的服务接口，如果不做密等性设计会造成严重的后果。

## 什么情况下需要做密等

对于所有的请求来说，无非分为写请求与读请求，对于读请求是具有天然密等性的，因为无论操作多少次数据本身的内容不会变，只不过是将数据查询出来。

但是写请求就要严格注意密等性了，不能我一次订单请求其实已经写进数据库了，但是因为网络原因逻辑层没有收到反馈就又享数据库中插入一条数据，这是不可取的。

在整个架构层面来说，涉及到写请求的就是与数据库打交道的**数据访问层**，而且对与数据库的操作无非是CRUD，接下来我们就依次看一下这四个动作。

### Create/Insert

在向数据库中插入数据时要注意的最重要的问题就是**主键自增**问题，如果主键是采取自增的方式，那么密等性就较难保证（除非数据库中可以生成全局唯一索引），所以一般的主键要选择与业务逻辑相关的业务主键，或者通过分布式ID生成器（twitter的雪花）生成全局唯一ID作为主键，这样在插入数据时因为已经有相同主键所以一定会插入失败，这样保证服务的密等性。

### Read/Select

对于数据库的读操作是天生具有密等性的。

### Update

对于更新操作来说要分为两种情况讨论。

如果更新操作时采用绝对值更新，那么更新操作就是密等的。如果更新操作时采用相对值更新（age++）那么更新操作就不是密等的。

**此时的更新操作就需要分布式锁来实现，通过对共享资源加锁，使得操作变为串行化，只有第一个操作执行成功后才继续其他操作。**

### Delete

对于删除操作来说，除非采用相对值删除（一般不允许这样操作），否则删除操作是密等的。





